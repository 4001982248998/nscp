<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2003/01/wi">
	<!--
	<?define boost = "false" ?>
	 -->
	<?ifdef var.boost ?>
		<?define PlatForm = "$(var.arch)" ?>
		<?define Mode = "Nightly" ?>
		<?define SysTray.ConfigurationName = "BOOST BUILD" ?>
	<?else?>
		<?if "$(var.SysTray.ConfigurationName)" = "Debug|Win32"?>
			<?define PlatForm = "Win32" ?>
			<?define Mode = "Debug" ?>
		<?elseif "$(var.SysTray.ConfigurationName)" = "Debug|x64"?>
			<?define PlatForm = "x64" ?>
			<?define Mode = "Debug" ?>
		<?elseif "$(var.SysTray.ConfigurationName)" = "Nightly|Win32"?>
			<?define PlatForm = "Win32" ?>
			<?define Mode = "Nightly" ?>
		<?elseif "$(var.SysTray.ConfigurationName)" = "Nightly|x64"?>
			<?define PlatForm = "x64" ?>
			<?define Mode = "Nightly" ?>
		<?else?>
			<?define PlatForm = "Unknown: plattform" ?>
		<?endif?>
	<?endif?>

	<?if "$(var.PlatForm)" = "x64"?>
		<?define PlatForm.x64 ?>
		<?define Postfix.GUID = "DD5862EE637C" ?>
	<?else?>
		<?define Postfix.GUID = "DD5862EE637B" ?>
		<?define PlatForm.Win32 ?>
	<?endif?>
	
	<?ifdef var.PlatForm.Win32?>
		<?define ProgramFiles = "ProgramFilesFolder" ?>
		<?define Win64 = "no" ?>
		<?define Plattform = "Intel" ?>
	<?else?>
		<?define ProgramFiles = "ProgramFiles64Folder" ?>
		<?define Win64 = "yes" ?>
		<?define Plattform = "x64" ?>
	<?endif?>
	<?ifndef var.Source ?>
		<?define Source = "../../$(var.PlatForm)/$(var.Mode)/" ?>
	<?endif?>
	<?ifndef var.Helpers ?>
		<?define Helpers = "../../$(var.PlatForm)/$(var.Mode)-helpers/" ?>
	<?endif?>

	<?include ../../AutoBuild.wxs ?>
	<?define Version.String = "$(var.Version.Major).$(var.Version.Minor).$(var.Version.Revision).$(var.Version.Build)" ?>
	<?define UpgradeCode = "0B36E3B7-0042-452d-B376-57E0C07ADDAA" ?>
	<?include config.wxs ?>

	<Product Id="????????-????-????-????-????????????" Name="$(var.App.Title) ($(var.PlatForm))" Language="1033" Version="$(var.Version.String)" Manufacturer="MySolutions NORDIC"
					UpgradeCode="$(var.UpgradeCode)">

		<Package Id="????????-????-????-????-????????????" Description="A simple windows monitor agent for (amongst others) Nagios."
						 Comments="This will appear in the file summary stream." InstallerVersion="200" Compressed="yes" Languages="1033" Platforms="$(var.Plattform)" />

		<Upgrade Id="$(var.UpgradeCode)">
			<UpgradeVersion Property="OLDAPPFOUND" IncludeMinimum="yes" Minimum="0.3.0.0" IncludeMaximum="yes" Maximum="$(var.Version.String)"/>
			<UpgradeVersion Property="NEWAPPFOUND" IncludeMinimum="no" Minimum="$(var.Version.String)" OnlyDetect="yes"/>
		</Upgrade>

		<?ifdef var.PlatForm.Win32?>
			<Condition Message="x64 bit version not supported (by installer) on Win32 bit platform (get Win32 bit version instead)">NOT VersionNT64</Condition>
		<?else?>
			<Condition Message="Win32 bit version not supported (by installer) on x64 bit platform (get x64 bit version instead)">VersionNT64</Condition>
		<?endif?>
		<Media Id="1" Cabinet="Product.cab" EmbedCab="yes" CompressionLevel="high">
		</Media>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="$(var.ProgramFiles)">
					<Directory Id="INSTALLLOCATION" Name="$(var.App.ShortPath)" LongName="$(var.App.Path)">
						<Component Id="MainClient" Guid="F6636DB0-A0B9-4dd2-B74C-$(var.Postfix.GUID)" Win64="$(var.Win64)">
							<File Id="NSClientEXE" Name="nsclient.exe" LongName="nsclient++.exe" DiskId="1"
										Source="$(var.Source)/nsclient++.exe" Vital="yes">
								<Shortcut Id="StartmenuNSClientTest" Directory="ProgramMenuDir" Name="NSCPTest"
													LongName="$(var.App.Title) ($(var.PlatForm), test)" WorkingDirectory="INSTALLDIR" Icon="nsclient.exe"
													IconIndex="0" Arguments="/test" Description="Run $(var.App.Title) in test mode"/>
								<Shortcut Id="StartmenuNSClientStart" Directory="ProgramMenuDir" Name="NSCPStrt"
													LongName="Start $(var.App.Title) ($(var.PlatForm))" WorkingDirectory='INSTALLDIR' Icon="nsclient.exe"
													IconIndex="0" Arguments="/start" Description="Start the $(var.App.Title) service"/>
								<Shortcut Id="StartmenuNSClientStop" Directory="ProgramMenuDir" Name="NSCPStop"
													LongName="Stop $(var.App.Title) ($(var.PlatForm))" WorkingDirectory='INSTALLDIR' Icon="nsclient.exe"
													IconIndex="0" Arguments="/stop" Description="Stop the $(var.App.Title) service"/>
								<Shortcut Id="StarmentNSCHelp" Target="[HELP_LINK]" Icon="doc.ico" Directory="ProgramMenuDir" Name="Help" LongName="Documentation" Description="Visit the NSClient++ WIKI for documentation">
									<Icon Id="doc.ico" SourceFile="help.ico"/>
								</Shortcut>
							</File>
							<File Id="NSClientTRAY" Name="nstray.exe" DiskId="1"
										Source="$(var.Source)/nstray.exe" Vital="yes">
								<Shortcut Id="StartmenuNSClientTray" Directory="ProgramMenuDir" Name="NSCPTray"
													LongName="$(var.App.Title) ($(var.PlatForm)) system tray)" WorkingDirectory="INSTALLDIR" Icon="nstray.exe"
													IconIndex="0" Description="Start the $(var.App.Title) systemtray agent"/>
							</File>
							<File Id="NSClientINI" Name="NSC.ini" LongName="NSC.ini" DiskId="1" Source="$(var.Path.ini)/NSC.ini" Vital="yes"/>
							<?ifdef var.boost ?>
								<File Id="Changelog" Name="change.log" LongName="changelog.txt" DiskId="1" Source="$(var.Source)/changelog.txt" Vital="no"/>
							<?else?>
								<File Id="Changelog" Name="change.log" LongName="changelog.txt" DiskId="1" Source="$(var.Source)/changelog" Vital="no"/>
							<?endif?>
							<File Id="Counters" Name="counters.def" LongName="counters.defs" DiskId="1" Source="$(var.Source)/counters.defs" Vital="no"/>
							<File Id="License" Name="license.txt" LongName="license.txt" DiskId="1" Source="$(var.Source)/license.txt" Vital="no"/>
							<RemoveFile Id="LogFile1" Name="nsclient.log" On="uninstall" />
							<RemoveFile Id="LogFile2" Name="nsc.log" On="uninstall" />
							<RemoveFile Id="OldConfig" Name="nsc.old" On="uninstall" />
							<RemoveFile Id="NewConfig" Name="nsc.new" On="uninstall" />
						</Component>
						<Directory Id="INSTALLLOCATION_MODS" Name="modules">
							<Component Id="NRPEListener" Guid="5A0246F8-5167-45db-B246-$(var.Postfix.GUID)" Win64="$(var.Win64)">
								<File Id="NRPEListenerDLL" Name="NRPELsnr.dll" LongName="NRPEListener.dll" DiskId="1" Source="$(var.Source)/modules/NRPEListener.dll" Vital="no" />
								<File Id="NRPEClientDLL" Name="NRPEClnt.dll" LongName="NRPEClient.dll" DiskId="1" Source="$(var.Source)/modules/NRPEClient.dll" Vital="no" />
							</Component>
							<Component Id="NSCListener" Guid="6DAF8BB9-9A56-48f5-B2C5-$(var.Postfix.GUID)" Win64="$(var.Win64)">
								<File Id="NSCListenerDLL" Name="NSCLsnr.dll" LongName="NSClientListener.dll" DiskId="1" Source="$(var.Source)/modules/NSClientListener.dll" Vital="no" />
							</Component>
							<Component Id="NSCA" Guid="8820A304-C596-4393-A72F-$(var.Postfix.GUID)" Win64="$(var.Win64)">
								<File Id="NSCAAgentDLL" Name="NSCAAgnt.dll" LongName="NSCAAgent.dll" DiskId="1" Source="$(var.Source)/modules/NSCAAgent.dll" Vital="no" />
							</Component>
							<Component Id="Plugins" Guid="9B490E67-5472-4266-96DC-$(var.Postfix.GUID)" Win64="$(var.Win64)">
								<File Id="A_DebugLogMetrics.dll" Name="ADebug.dll" LongName="A_DebugLogMetrics.dll" DiskId="1" Source="$(var.Source)/modules/A_DebugLogMetrics.dll" Vital="no" />
								<File Id="ModCheckEventLog.dll" Name="EvntLg.dll" LongName="CheckEventLog.dll" DiskId="1" Source="$(var.Source)/modules/CheckEventLog.dll" Vital="no" />
								<File Id="ModCheckExternalScripts.dll" Name="ExtScr.dll" LongName="CheckExternalScripts.dll" DiskId="1" Source="$(var.Source)/modules/CheckExternalScripts.dll" Vital="no" />
								<File Id="ModCheckHelpers.dll" Name="Helpers.dll" LongName="CheckHelpers.dll" DiskId="1" Source="$(var.Source)/modules/CheckHelpers.dll" Vital="no" />
								<File Id="ModCheckSystem.dll" Name="System.dll" LongName="CheckSystem.dll" DiskId="1" Source="$(var.Source)/modules/CheckSystem.dll" Vital="no" />
								<File Id="ModCheckWMI.dll" Name="WMI.dll" LongName="CheckWMI.dll" DiskId="1" Source="$(var.Source)/modules/CheckWMI.dll" Vital="no" />
								<File Id="ModFileLogger.dll" Name="Logger.dll" LongName="FileLogger.dll" DiskId="1" Source="$(var.Source)/modules/FileLogger.dll" Vital="no" />
								<File Id="ModLUAScript.dll" Name="LUAScr.dll" LongName="LUAScript.dll" DiskId="1" Source="$(var.Source)/modules/LUAScript.dll" Vital="no" />
								<File Id="ModRemoteConfiguration.dll" Name="RmtCfg.dll" LongName="RemoteConfiguration.dll" DiskId="1" Source="$(var.Source)/modules/RemoteConfiguration.dll" Vital="no" />
								<File Id="ModSysTray.dll" Name="SysTray.dll" LongName="SysTray.dll" DiskId="1" Source="$(var.Source)/modules/SysTray.dll" Vital="no" />
								<File Id="ModCheckDisk.dll" Name="CheckDsk.dll" LongName="CheckDisk.dll" DiskId="1" Source="$(var.Source)/modules/CheckDisk.dll" Vital="no" />
								<File Id="ModCheckTaskSched.dll" Name="TaskSch.dll" LongName="CheckTaskSched.dll" DiskId="1" Source="$(var.Source)/modules/CheckTaskSched.dll" Vital="no" />
							</Component>
						</Directory>
						<Directory Id="INSTALLLOCATION_SCRIPTS" Name="scripts">
							<Component Id="Scripts" Guid="9B490E67-5472-4267-96DC-$(var.Postfix.GUID)" Win64="$(var.Win64)">
								<File Id="scriptargs.bat" Name="args.bat" LongName="args.bat" DiskId="1" Source="$(var.Source)/scripts/args.bat" Vital="no" />
								<File Id="scriptcheck_vb.vbs" Name="check_vb.vbs" LongName="check_vb.vbs" DiskId="1" Source="$(var.Source)/scripts/check_vb.vbs" Vital="no" />
								<File Id="scriptcritical.bat" Name="critical.bat" LongName="critical.bat" DiskId="1" Source="$(var.Source)/scripts/critical.bat" Vital="no" />
								<File Id="scriptmulti_line.bat" Name="mline.bat" LongName="multi_line.bat" DiskId="1" Source="$(var.Source)/scripts/multi_line.bat" Vital="no" />
								<File Id="scriptok.bat" Name="ok.bat" LongName="ok.bat" DiskId="1" Source="$(var.Source)/scripts/ok.bat" Vital="no" />
								<File Id="scriptpowershell.ps1" Name="pwrshell.ps1" LongName="powershell.ps1" DiskId="1" Source="$(var.Source)/scripts/powershell.ps1" Vital="no" />
								<File Id="scripttest.lua" Name="test.lua" LongName="test.lua" DiskId="1" Source="$(var.Source)/scripts/test.lua" Vital="no" />
							</Component>
						</Directory>
					</Directory>
				</Directory>

			<!-- ### Start Menu Items ### -->
				<Directory Id="ProgramMenuFolder" Name="PMenu" LongName="Programs">
					<Directory Id="ProgramMenuDir" Name='NSClient' LongName="$(var.App.StartMenuPath)" />
				</Directory>
			</Directory>

		<!-- ### FEATURES START ### -->
			<Feature Id="ProductFeature" Title="NSClient++ $(var.PlatForm)" Description="Binaries for $(var.PlatForm)"
							 Display="expand"  Level="1" ConfigurableDirectory="INSTALLLOCATION" Absent="disallow">
				<Feature Id="MainProgram" Title="Program" Description="Main Service" Level="1" Absent="disallow">
					<ComponentRef Id="MainClient" />
			</Feature>
			<Feature Id="Plugins" Title="Plugins" Description="Plugins" Level="1" Absent="disallow">
				<Feature Id="CheckPlugins" Title="Check Plugins" Description="Various plugins to check your system. (Includes all check plugins)" Level="1">
					<ComponentRef Id="Plugins" />
				</Feature>
				<Feature Id="NRPEPlugins" Title="NRPE Support" Description="NRPE Listener Plugin. Support for the more vercitile NRPE protocol (check_nrpe)" Level="1" Absent="disallow">
					<ComponentRef Id="NRPEListener" />
				</Feature>
				<Feature Id="NSCPlugins" Title="NSClient support" Description="NSClient Listener Plugin. Support for the old NSClient protocol (check_nt)" Level="1" Absent="disallow">
					<ComponentRef Id="NSCListener" />
				</Feature>
				<Feature Id="NSCAPlugin" Title="NSCA plugin" Description="Plugin to submit passive results to an NSCA server" Level="1" Absent="disallow">
					<ComponentRef Id="NSCA" />
				</Feature>
				<Feature Id="SampleScripts" Title="Sample Scripts" Description="Some sample client-side scripts to use with NRPE" Level="1" Absent="disallow">
					<ComponentRef Id="Scripts" />
				</Feature>
			</Feature>
		</Feature>

<!--
		<Condition Message='This installation can only run in full UI mode.'>
			UILevel = 5
		</Condition>
-->
		<Property Id='ARPCOMMENTS'>NSClient++ is a </Property>
		<Property Id='ARPCONTACT'>michael@medin.name</Property>
		<Property Id='ARPHELPLINK'>http://nsclient.org</Property>
		<Property Id='ARPURLINFOABOUT'>http://nsclient.org</Property>
		<Property Id='ARPURLUPDATEINFO'>http://nsclient.org</Property>
		<Property Id='ARPHELPTELEPHONE'>http://nsclient.org</Property>
		<Property Id='ARPPRODUCTICON'>nsclient.exe</Property>

		<Property Id="CONF_CHECKS_DEFAULT"></Property>
		<Property Id="CONF_NSCLIENT_DEFAULT"></Property>
		<Property Id="CONF_NRPE_DEFAULT"></Property>
		<Property Id="CONF_NSCA_DEFAULT"></Property>
		<Property Id="CONF_WMI_DEFAULT"></Property>
		<Property Id="ALLOW_CONFIGURATION" />

		<!-- CONFIGURE DEFAULT VALUES-->
		<!--
		<Property Id="ALLOWED_HOSTS_DEFAULT">$$EMPTY$$</Property>
		<Property Id="NSCLIENT_PWD_DEFAULT">$$EMPTY$$</Property>
			-->

		<!-- CONFIGURE THE INSTALLER -->
		<Property Id='INSCON_CONFIGURE'>1</Property>
		<Property Id='MAIN_CONFIGURATION_FILE'>NSC.ini</Property>
		<Property Id='CUSTOM_CONFIGURATION_FILE'>NSC.ini</Property>
		<Property Id='INSTALL_SVC_EXE'>NSClient++.exe</Property>
		<Property Id='INSTALL_SVC_SHORTNAME'>NSClientpp</Property>
		<Property Id='INSTALL_SVC_LONGNAME'>$(var.App.Title) ($(var.PlatForm))</Property>
		<Property Id='INSTALL_SVC_DESC'>Monitoring agent for nagios (and others) used to respond to status queries.</Property>

		<Property Id='HELP_LINK'>http://nsclient.org/nscp/</Property>

		<Property Id='SHOW_START_ON_EXIT'>1</Property>
		<Property Id='START_SERVICE_ON_EXIT'></Property>
		<Property Id='SHOW_DONATE_ON_EXIT'>1</Property>
		<Property Id='DONATE_ON_EXIT'></Property>
		<Property Id='KEEP_WHICH_CONFIG'>NEW</Property>
		<!--
		<Property Id='MAIN_CONFIGURATION_FILE'>NSC.ini</Property>
			-->

		<!--
			<Property Id='ARPREADME'>path</Property>  
			<Property Id='ARPSIZE'>app size in kilobytes</Property>
			-->

		<CustomAction Id='ReadOldConfig' BinaryKey='InstallerHelper' DllEntry='ImportConfig' Impersonate='yes' />
		<CustomAction Id='WriteNewConfig' BinaryKey='InstallerHelper' DllEntry='UpdateConfig' Impersonate='yes' />
		<CustomAction Id='InstallService' BinaryKey='InstallerHelper' DllEntry='UpdateConfig' Impersonate='yes' />
		<CustomAction Id='UnInstallService' BinaryKey='InstallerHelper' DllEntry='UninstallService' Impersonate='yes' />
		<CustomAction Id='StartService' BinaryKey='InstallerHelper' DllEntry='StartTheService' Impersonate='yes' Return='asyncNoWait' Execute="immediate"/>
		<CustomAction Id="PreventDowngrading" Error="Newer version already installed." />



		<Binary Id='InstallerHelper' SourceFile='$(var.Helpers)/installer_dll.dll' />

		<InstallExecuteSequence>
			<RemoveExistingProducts After='InstallInitialize'/>
			<Custom Action="PreventDowngrading" After="FindRelatedProducts">NEWAPPFOUND</Custom>
			<Custom Action="InstallService" After='InstallFinalize'>NOT REMOVE</Custom>
			<Custom Action="UnInstallService" Before='RemoveFiles'>REMOVE="ALL"</Custom>
		</InstallExecuteSequence>

		<InstallUISequence>
			<Custom Action="PreventDowngrading" After="FindRelatedProducts">NEWAPPFOUND</Custom>
		</InstallUISequence>

		<Property Id="ALLUSERS"><![CDATA[2]]></Property>

		<!-- ### User Interfaces ### -->
		<UIRef Id="WixUI_Mondo" />
		<UIRef Id="WixUI_ErrorProgressText" />

		<!-- ### Icons -->
		<Icon Id="nsclient.exe" SourceFile="$(var.Source)/NSClient++.exe" />
		<Icon Id="nstray.exe" SourceFile="$(var.Source)/nstray.exe" />
	</Product>
</Wix>
